<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - BitFun2025.com</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<header>
    <img src="{{ url_for('static', filename='bitfunlogo.png') }}" alt="BitFun.com Logo" class="logo">
    <h1>BitFun2025.com</h1>
    <h2>Dashboard</h2>
    <button onclick="location.href='{{ url_for('graduatoriainfo') }}'" class="btn-grad">üèÜ Graduatoria Reale</button>
</header>

<section class="dashboard">

    <!-- Benvenuto -->
    <div class="welcome-box">
        <h2>üëã Benvenuto, {{ user['nome'] }} {{ user['cognome'] }}</h2>
        <p><strong>Wallet:</strong> {{ user['wallet'] or 'Nessun wallet registrato' }}</p>
    </div>

    <!-- Referral link -->
    {% if user['is_abbonato'] == 1 and user['ha_pagato'] == 1 %}
    <div class="referral-box">
        <h3>üîó Il tuo referral link</h3>
        <input type="text" id="referralLink" value="{{ url_for('register', ref=user['id'], _external=True) }}" readonly>
        <button onclick="copyReferral()">Copia</button>
    </div>
    {% else %}
    <div class="referral-box blocked">
        <h3>üîó Referral link</h3>
        <p>Devi completare il pagamento per avere il tuo referral link.</p>
    </div>
    {% endif %}

    <!-- Pulsante rinnovo con timer -->
    <div class="renew-box">
        <button onclick="location.href='{{ url_for('pagamento_bitcoin') }}'" class="btn-renew">üîÑ Rinnova Ora</button>
        <div id="countdown" class="countdown-timer"></div>
    </div>

    <!-- Statistiche personali -->
    <div class="stats-grid">
        <div class="stat-box">
            <h4>üì¶ Abbonamenti Pagati</h4>
            <p>{{ user['abbonamenti_pagati'] }}</p>
        </div>
        <div class="stat-box">
            <h4>üì§ BTC Inviati</h4>
            <p>{{ btc_inviati }} BTC</p>
        </div>
        <div class="stat-box">
            <h4>üì• BTC Ricevuti</h4>
            <p>{{ btc_ricevuti }} BTC</p>
        </div>
    </div>

    <!-- Totale Network -->
    <div class="network-total">
        <h3>üåç Totale Network</h3>
        <p>Referral diretti: <strong>{{ invitati|length }}</strong></p>
        <p>Totale generato mensile: <strong>{{ (invitati|length * prezzo_fisso_btc)|round(8) }} BTC</strong></p>
    </div>

    <!-- Lista referral -->
    <div class="referral-list">
        <h3>üë• I tuoi referral</h3>
        {% if invitati %}
        <table>
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Cognome</th>
                    <th>Wallet</th>
                </tr>
            </thead>
            <tbody>
                {% for ref in invitati %}
                <tr>
                    <td>{{ ref['nome'] }}</td>
                    <td>{{ ref['cognome'] }}</td>
                    <td>{{ ref['wallet_address'] or 'Non disponibile' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>Nessun referral ancora.</p>
        {% endif %}
    </div>

    <!-- Box commissioni ricevute da -->
    <div class="commission-box">
        <h3>üí∏ Commissioni ricevute da</h3>
        {% if user['commission_from'] %}
            <p><strong>{{ user['commission_from']['nome'] }} {{ user['commission_from']['cognome'] }}</strong></p>
            <p>Wallet: {{ user['commission_from']['wallet_address'] or 'Non disponibile' }}</p>
        {% else %}
            <p>Nessuna commissione ricevuta ancora.</p>
        {% endif %}
    </div>

</section>

<!-- Box esclusivo per abbonati -->
{% if user['abbonamento_attivo'] == 1 %}
<div class="exclusive-box">
    <img src="{{ url_for('static', filename='bitfunlogo.png') }}" alt="BitFun Logo" class="exclusive-logo">
    <h3>‚ú® Esclusiva solo per abbonati</h3>
    <p>
        Presto sveleremo in anteprima la data del <strong>lancio del Token ufficiale di BitFun2025</strong>. <br>
        Sarai tra i primi a conoscerlo. Mantieni il segreto ü§´
    </p>
</div>
{% endif %}

<script>
function copyReferral() {
    var copyText = document.getElementById("referralLink");
    copyText.select();
    document.execCommand("copy");
    alert("Referral link copiato!");
}

// Timer rinnovo
var abbonamentoDataStr = "{{ user['data_abbonamento'] }}";

if (abbonamentoDataStr && abbonamentoDataStr !== "None") {
    // Converte la stringa ricevuta da Flask in oggetto Date
    var abbonamentoData = new Date(abbonamentoDataStr);

    // Calcola scadenza a +30 giorni
    var scadenza = new Date(abbonamentoData);
    scadenza.setDate(scadenza.getDate() + 30);

    function aggiornaCountdown() {
        var now = new Date().getTime();
        var distance = scadenza - now;

        if (distance <= 0) {
            document.getElementById("countdown").innerHTML = "‚õî Abbonamento scaduto!";
            document.getElementById("countdown").classList.add("warning");
            return;
        }

        var giorni = Math.floor(distance / (1000 * 60 * 60 * 24));
        var ore = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        var minuti = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        var secondi = Math.floor((distance % (1000 * 60)) / 1000);

        var timerText = giorni + "g " + ore + "h " + minuti + "m " + secondi + "s ";
        document.getElementById("countdown").innerHTML = "‚è≥ Scade tra: " + timerText;

        if (giorni < 3) {
            document.getElementById("countdown").classList.add("warning");
        }
    }

    aggiornaCountdown(); // mostro subito al caricamento
    setInterval(aggiornaCountdown, 1000);

} else {
    document.getElementById("countdown").innerHTML = "‚ö† Nessuna data abbonamento trovata";
}
</script>

<style>
.dashboard {
    max-width: 900px;
    margin: auto;
    padding: 20px;
}
.welcome-box, .referral-box, .network-total, .commission-box, .exclusive-box {
    background: #f4f4f4;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
}
.stats-grid {
    display: flex;
    gap: 20px;
    margin: 20px 0;
}
.stat-box {
    flex: 1;
    background: #eaeaea;
    padding: 15px;
    border-radius: 10px;
    text-align: center;
}
.referral-list table {
    width: 100%;
    border-collapse: collapse;
}
.referral-list th, .referral-list td {
    padding: 10px;
    border: 1px solid #ccc;
}
.referral-box input {
    width: 70%;
    padding: 5px;
}
.referral-box button {
    padding: 5px 10px;
    margin-left: 10px;
}
.btn-grad {
    background: #ff9800;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    color: #fff;
    font-weight: bold;
}
.btn-renew {
    background: #4caf50;
    border: none;
    padding: 12px 25px;
    border-radius: 10px;
    cursor: pointer;
    color: #fff;
    font-size: 16px;
    font-weight: bold;
}
.btn-renew:hover { background: #45a049; }

.countdown-timer {
    font-size: 16px;
    font-weight: bold;
    color: #333;
    margin-left: 15px;
}
.countdown-timer.warning {
    color: #d9534f;
}

.exclusive-box {
    border: 2px solid #ff9800;
    text-align: center;
    padding: 20px;
}
.exclusive-logo {
    width: 60px;
    margin-bottom: 10px;
}
</style>

<footer>
    <p>Hai bisogno di aiuto? Contatta il nostro supporto: 
        <a href="mailto:bitfuncentral@outlook.com">bitfuncentral@outlook.com</a>
    </p>
</footer>
</body>
</html>
